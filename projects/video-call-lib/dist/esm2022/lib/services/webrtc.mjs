import { Injectable } from '@angular/core';
import { socket } from './socket.service';
import { Capacitor } from '@capacitor/core';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export class WebRTCService {
    constructor(http) {
        this.http = http;
        this.currentRoom = '';
        this.isInitialized = false;
        this.remoteVideoElement = null;
    }
    baseUrl() {
        const platform = Capacitor.getPlatform();
        console.log('Platform detected:', platform);
        // For Android emulator
        if (platform === 'android') {
            return 'http://10.0.2.2:3000';
        }
        // For iOS and web
        return 'http://localhost:3000';
    }
    async init(room, localVideo, remoteVideo) {
        try {
            // Prevent re-initialization and remove old listeners
            if (this.isInitialized) {
                console.log('Already initialized, cleaning up...');
                this.cleanup();
            }
            this.currentRoom = room;
            this.remoteVideoElement = remoteVideo;
            this.remoteStream = new MediaStream();
            console.log('Initializing WebRTC for room:', room);
            let iceServers = [];
            try {
                const iceServersResponse = await this.http
                    .get(`${this.baseUrl()}/ice`)
                    .toPromise();
                if (Array.isArray(iceServersResponse)) {
                    iceServers = iceServersResponse;
                }
            }
            catch (err) {
                console.warn('Failed to fetch ICE servers, using empty array:', err);
            }
            const peerConfig = { iceServers };
            this.pc = new RTCPeerConnection(peerConfig);
            this.localStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user' },
                audio: true
            }).catch(err => {
                console.error('Error getting media devices:', err.message);
                throw new Error('Failed to access camera/microphone: ' + err.message);
            });
            console.log('Local stream obtained:', this.localStream.getTracks().map(t => t.kind));
            localVideo.srcObject = this.localStream;
            this.localStream.getTracks().forEach(t => this.pc.addTrack(t, this.localStream));
            this.pc.ontrack = e => {
                console.log('Remote track received:', e.track.kind, 'Track enabled:', e.track.enabled, 'Stream count:', e.streams.length);
                // Add the track to the remote stream instead of replacing the entire stream
                // This ensures we keep both audio and video tracks
                const trackExists = this.remoteStream.getTracks().find(t => t.id === e.track.id);
                if (!trackExists) {
                    this.remoteStream.addTrack(e.track);
                    console.log('Added', e.track.kind, 'track to remote stream. Current tracks:', this.remoteStream.getTracks().map(t => t.kind));
                }
                else {
                    console.log('Track', e.track.id, 'already exists in remote stream');
                }
                if (this.remoteVideoElement) {
                    // Ensure the video element has the stream
                    if (this.remoteVideoElement.srcObject !== this.remoteStream) {
                        this.remoteVideoElement.srcObject = this.remoteStream;
                        console.log('âœ“ Remote video srcObject updated');
                    }
                    console.log('Remote stream tracks:', this.remoteStream.getTracks().map(t => ({ kind: t.kind, enabled: t.enabled, id: t.id })));
                }
                else {
                    console.warn('âš ï¸ Remote video element not available');
                }
            };
            this.pc.onconnectionstatechange = () => {
                console.log('Peer connection state:', this.pc.connectionState);
                if (this.pc.connectionState === 'failed') {
                    console.error('Peer connection failed');
                }
                if (this.pc.connectionState === 'connected') {
                    console.log('Peer connection established');
                }
            };
            this.pc.oniceconnectionstatechange = () => {
                console.log('ICE connection state:', this.pc.iceConnectionState);
            };
            this.pc.onicegatheringstatechange = () => {
                console.log('ICE gathering state:', this.pc.iceGatheringState);
            };
            this.pc.onicecandidate = e => {
                if (e.candidate) {
                    console.log('Sending ICE candidate');
                    socket.emit('ice', { room, candidate: e.candidate });
                }
            };
            // Register socket listeners only once
            this.setupSocketListeners(room);
            console.log('Joining room:', room);
            console.log('ðŸ“ Make sure you have 2 peers in the same room for video to work!');
            socket.emit('join', { room });
            this.isInitialized = true;
        }
        catch (err) {
            console.error('Error initializing WebRTC:', err);
            throw err;
        }
    }
    setupSocketListeners(room) {
        // Remove old listeners first
        socket.off('peer-joined');
        socket.off('offer');
        socket.off('answer');
        socket.off('ice');
        socket.on('peer-joined', async () => {
            console.log('ðŸ”” [SIGNALING] Peer joined the room, creating offer...');
            try {
                const offer = await this.pc.createOffer();
                console.log('ðŸ“¤ [SIGNALING] Offer created:', offer.type);
                await this.pc.setLocalDescription(offer);
                console.log('âœ“ [SIGNALING] Local description set, sending offer');
                socket.emit('offer', { room, offer });
            }
            catch (err) {
                console.error('âŒ [SIGNALING] Error creating offer:', err);
            }
        });
        socket.on('offer', async (data) => {
            console.log('ðŸ“¥ [SIGNALING] Received offer from remote peer');
            try {
                const offer = data.offer || data;
                console.log('ðŸ“¥ [SIGNALING] Setting remote description for offer');
                await this.pc.setRemoteDescription(new RTCSessionDescription(offer));
                console.log('âœ“ [SIGNALING] Remote description set, creating answer...');
                const answer = await this.pc.createAnswer();
                console.log('ðŸ“¤ [SIGNALING] Answer created:', answer.type);
                await this.pc.setLocalDescription(answer);
                console.log('âœ“ [SIGNALING] Local description set, sending answer');
                socket.emit('answer', { room, answer });
            }
            catch (err) {
                console.error('âŒ [SIGNALING] Error handling offer:', err);
            }
        });
        socket.on('answer', async (data) => {
            console.log('ðŸ“¥ [SIGNALING] Received answer from remote peer');
            try {
                const answer = data.answer || data;
                console.log('ðŸ“¥ [SIGNALING] Setting remote description from answer:', answer.type);
                await this.pc.setRemoteDescription(new RTCSessionDescription(answer));
                console.log('âœ“ [SIGNALING] Remote description set - Connection should be established');
            }
            catch (err) {
                console.error('âŒ [SIGNALING] Error handling answer:', err);
            }
        });
        socket.on('ice', async (data) => {
            try {
                const candidate = data.candidate || data;
                if (candidate) {
                    console.log('ðŸ§Š [ICE] Adding ICE candidate');
                    await this.pc.addIceCandidate(new RTCIceCandidate(candidate));
                }
            }
            catch (err) {
                console.error('âŒ [ICE] Error adding ice candidate:', err);
            }
        });
    }
    cleanup() {
        socket.off('peer-joined');
        socket.off('offer');
        socket.off('answer');
        socket.off('ice');
    }
    async switchCamera() {
        if (!this.localStream) {
            console.warn('Local stream not available');
            return;
        }
        try {
            const videoTracks = this.localStream.getVideoTracks();
            if (videoTracks.length === 0) {
                console.warn('No video tracks available');
                return;
            }
            const videoTrack = videoTracks[0];
            const settings = videoTrack.getSettings();
            const newFacing = settings.facingMode === 'user' ? 'environment' : 'user';
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: newFacing },
                audio: true
            });
            const newTrack = stream.getVideoTracks()[0];
            const sender = this.pc.getSenders().find(s => s.track?.kind === 'video');
            if (sender) {
                await sender.replaceTrack(newTrack);
            }
            videoTrack.stop();
            this.localStream.removeTrack(videoTrack);
            this.localStream.addTrack(newTrack);
        }
        catch (err) {
            console.error('Error switching camera:', err);
        }
    }
    leave() {
        console.log('Leaving call...');
        this.cleanup();
        this.isInitialized = false;
        this.localStream?.getTracks().forEach(t => t.stop());
        this.pc?.close();
        socket.emit('leave', { room: this.currentRoom });
    }
    pause() {
        this.localStream?.getTracks().forEach(t => t.enabled = false);
    }
    resume() {
        this.localStream?.getTracks().forEach(t => t.enabled = true);
    }
    toggleAudio(enabled) {
        this.localStream?.getAudioTracks().forEach(t => t.enabled = enabled);
    }
    toggleVideo(enabled) {
        this.localStream?.getVideoTracks().forEach(t => t.enabled = enabled);
    }
    static { this.Éµfac = function WebRTCService_Factory(__ngFactoryType__) { return new (__ngFactoryType__ || WebRTCService)(i0.ÉµÉµinject(i1.HttpClient)); }; }
    static { this.Éµprov = /*@__PURE__*/ i0.ÉµÉµdefineInjectable({ token: WebRTCService, factory: WebRTCService.Éµfac, providedIn: 'root' }); }
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ÉµsetClassMetadata(WebRTCService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], () => [{ type: i1.HttpClient }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2VicnRjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9zZXJ2aWNlcy93ZWJydGMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDMUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7QUFHNUMsTUFBTSxPQUFPLGFBQWE7SUFTeEIsWUFBb0IsSUFBZ0I7UUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUo1QixnQkFBVyxHQUFXLEVBQUUsQ0FBQztRQUN6QixrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUN0Qix1QkFBa0IsR0FBNEIsSUFBSSxDQUFDO0lBRXBCLENBQUM7SUFFaEMsT0FBTztRQUNiLE1BQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRTVDLHVCQUF1QjtRQUN2QixJQUFJLFFBQVEsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUMzQixPQUFPLHNCQUFzQixDQUFDO1FBQ2hDLENBQUM7UUFDRCxrQkFBa0I7UUFDbEIsT0FBTyx1QkFBdUIsQ0FBQztJQUNqQyxDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFZLEVBQUUsVUFBNEIsRUFBRSxXQUE2QjtRQUNsRixJQUFJLENBQUM7WUFDSCxxREFBcUQ7WUFDckQsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7Z0JBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMscUNBQXFDLENBQUMsQ0FBQztnQkFDbkQsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2pCLENBQUM7WUFFRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztZQUN4QixJQUFJLENB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QUFDO0lBRUQsV0FBVyxDQUFDLE9BQWdCO1FBQzFCLElBQUksQ0FBQyxXQUFXLEVBQUUsY0FBYyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRUQsV0FBVyxDQUFDLE9BQWdCO1FBQzFCLElBQUksQ0FBQyxXQUFXLEVBQUUsY0FBYyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsQ0FBQztJQUN2RSxDQUFDOzhHQXJRVSxhQUFhO3VFQUFiLGFBQWEsV0FBYixhQUFhLG1CQURBLE1BQU07O2lGQUNuQixhQUFhO2NBRHpCLFVBQVU7ZUFBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IHNvY2tldCB9IGZyb20gJy4vc29ja2V0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDYXBhY2l0b3IgfSBmcm9tICdAY2FwYWNpdG9yL2NvcmUnO1xyXG5cclxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcclxuZXhwb3J0IGNsYXNzIFdlYlJUQ1NlcnZpY2Uge1xyXG5cclxuICBwcml2YXRlIHBjITogUlRDUGVlckNvbm5lY3Rpb247XHJcbiAgcHJpdmF0ZSBsb2NhbFN0cmVhbSE6IE1lZGlhU3RyZWFtO1xyXG4gIHByaXZhdGUgcmVtb3RlU3RyZWFtITogTWVkaWFTdHJlYW07XHJcbiAgcHJpdmF0ZSBjdXJyZW50Um9vbTogc3RyaW5nID0gJyc7XHJcbiAgcHJpdmF0ZSBpc0luaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgcHJpdmF0ZSByZW1vdGVWaWRlb0VsZW1lbnQ6IEhUTUxWaWRlb0VsZW1lbnQgfCBudWxsID0gbnVsbDtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7fVxyXG5cclxuICBwcml2YXRlIGJhc2VVcmwoKSB7XHJcbiAgICBjb25zdCBwbGF0Zm9ybSA9IENhcGFjaXRvci5nZXRQbGF0Zm9ybSgpO1xyXG4gICAgY29uc29sZS5sb2coJ1BsYXRmb3JtIGRldGVjdGVkOicsIHBsYXRmb3JtKTtcclxuICAgIFxyXG4gICAgLy8gRm9yIEFuZHJvaWQgZW11bGF0b3JcclxuICAgIGlmIChwbGF0Zm9ybSA9PT0gJ2FuZHJvaWQnKSB7XHJcbiAgICAgIHJldHVybiAnaHR0cDovLzEwLjAuMi4yOjMwMDAnO1xyXG4gICAgfVxyXG4gICAgLy8gRm9yIGlPUyBhbmQgd2ViXHJcbiAgICByZXR1cm4gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCc7XHJcbiAgfVxyXG5cclxuICBhc3luYyBpbml0KHJvb206IHN0cmluZywgbG9jYWxWaWRlbzogSFRNTFZpZGVvRWxlbWVudCwgcmVtb3RlVmlkZW86IEhUTUxWaWRlb0VsZW1lbnQpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIFByZXZlbnQgcmUtaW5pdGlhbGl6YXRpb24gYW5kIHJlbW92ZSBvbGQgbGlzdGVuZXJzXHJcbiAgICAgIGlmICh0aGlzLmlzSW5pdGlhbGl6ZWQpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnQWxyZWFkeSBpbml0aWFsaXplZCwgY2xlYW5pbmcgdXAuLi4nKTtcclxuICAgICAgICB0aGlzLmNsZWFudXAoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5jdXJyZW50Um9vbSA9IHJvb207XHJcbiAgICAgIHRoaXMucmVtb3RlVmlkZW9FbGVtZW50ID0gcmVtb3RlVmlkZW87XHJcbiAgICAgIHRoaXMucmVtb3RlU3RyZWFtID0gbmV3IE1lZGlhU3RyZWFtKCk7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdJbml0aWFsaXppbmcgV2ViUlRDIGZvciByb29tOicsIHJvb20pO1xyXG5cclxuICAgICAgbGV0IGljZVNlcnZlcnM6IFJUQ0ljZVNlcnZlcltdID0gW107XHJcbiAgICAgIFxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGljZVNlcnZlcnNSZXNwb25zZSA9IGF3YWl0IHRoaXMuaHR0cFxyXG4gICAgICAgICAgLmdldDxSVENJY2VTZXJ2ZXJbXT4oYCR7dGhpcy5iYXNlVXJsKCl9L2ljZWApXHJcbiAgICAgICAgICAudG9Qcm9taXNlKCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaWNlU2VydmVyc1Jlc3BvbnNlKSkge1xyXG4gICAgICAgICAgaWNlU2VydmVycyA9IGljZVNlcnZlcnNSZXNwb25zZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGZldGNoIElDRSBzZXJ2ZXJzLCB1c2luZyBlbXB0eSBhcnJheTonLCBlcnIpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBwZWVyQ29uZmlnOiBSVENDb25maWd1cmF0aW9uID0geyBpY2VTZXJ2ZXJzIH07XHJcbiAgICAgIHRoaXMucGMgPSBuZXcgUlRDUGVlckNvbm5lY3Rpb24ocGVlckNvbmZpZyk7XHJcblxyXG4gICAgICB0aGlzLmxvY2FsU3RyZWFtID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoe1xyXG4gICAgICAgIHZpZGVvOiB7IGZhY2luZ01vZGU6ICd1c2VyJyB9LFxyXG4gICAgICAgIGF1ZGlvOiB0cnVlXHJcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2V0dGluZyBtZWRpYSBkZXZpY2VzOicsIGVyci5tZXNzYWdlKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBhY2Nlc3MgY2FtZXJhL21pY3JvcGhvbmU6ICcgKyBlcnIubWVzc2FnZSk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coJ0xvY2FsIHN0cmVhbSBvYnRhaW5lZDonLCB0aGlzLmxvY2FsU3RyZWFtLmdldFRyYWNrcygpLm1hcCh0ID0+IHQua2luZCkpO1xyXG4gICAgICBsb2NhbFZpZGVvLnNyY09iamVjdCA9IHRoaXMubG9jYWxTdHJlYW07XHJcblxyXG4gICAgICB0aGlzLmxvY2FsU3RyZWFtLmdldFRyYWNrcygpLmZvckVhY2godCA9PlxyXG4gICAgICAgIHRoaXMucGMuYWRkVHJhY2sodCwgdGhpcy5sb2NhbFN0cmVhbSlcclxuICAgICAgKTtcclxuXHJcbiAgICAgIHRoaXMucGMub250cmFjayA9IGUgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdSZW1vdGUgdHJhY2sgcmVjZWl2ZWQ6JywgZS50cmFjay5raW5kLCAnVHJhY2sgZW5hYmxlZDonLCBlLnRyYWNrLmVuYWJsZWQsICdTdHJlYW0gY291bnQ6JywgZS5zdHJlYW1zLmxlbmd0aCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQWRkIHRoZSB0cmFjayB0byB0aGUgcmVtb3RlIHN0cmVhbSBpbnN0ZWFkIG9mIHJlcGxhY2luZyB0aGUgZW50aXJlIHN0cmVhbVxyXG4gICAgICAgIC8vIFRoaXMgZW5zdXJlcyB3ZSBrZWVwIGJvdGggYXVkaW8gYW5kIHZpZGVvIHRyYWNrc1xyXG4gICAgICAgIGNvbnN0IHRyYWNrRXhpc3RzID0gdGhpcy5yZW1vdGVTdHJlYW0uZ2V0VHJhY2tzKCkuZmluZCh0ID0+IHQuaWQgPT09IGUudHJhY2suaWQpO1xyXG4gICAgICAgIGlmICghdHJhY2tFeGlzdHMpIHtcclxuICAgICAgICAgIHRoaXMucmVtb3RlU3RyZWFtLmFkZFRyYWNrKGUudHJhY2spO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ0FkZGVkJywgZS50cmFjay5raW5kLCAndHJhY2sgdG8gcmVtb3RlIHN0cmVhbS4gQ3VycmVudCB0cmFja3M6JywgdGhpcy5yZW1vdGVTdHJlYW0uZ2V0VHJhY2tzKCkubWFwKHQgPT4gdC5raW5kKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdUcmFjaycsIGUudHJhY2suaWQsICdhbHJlYWR5IGV4aXN0cyBpbiByZW1vdGUgc3RyZWFtJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICh0aGlzLnJlbW90ZVZpZGVvRWxlbWVudCkge1xyXG4gICAgICAgICAgLy8gRW5zdXJlIHRoZSB2aWRlbyBlbGVtZW50IGhhcyB0aGUgc3RyZWFtXHJcbiAgICAgICAgICBpZiAodGhpcy5yZW1vdGVWaWRlb0VsZW1lbnQuc3JjT2JqZWN0ICE9PSB0aGlzLnJlbW90ZVN0cmVhbSkge1xyXG4gICAgICAgICAgICB0aGlzLnJlbW90ZVZpZGVvRWxlbWVudC5zcmNPYmplY3QgPSB0aGlzLnJlbW90ZVN0cmVhbTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ+KckyBSZW1vdGUgdmlkZW8gc3JjT2JqZWN0IHVwZGF0ZWQnKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdSZW1vdGUgc3RyZWFtIHRyYWNrczonLCB0aGlzLnJlbW90ZVN0cmVhbS5nZXRUcmFja3MoKS5tYXAodCA9PiAoeyBraW5kOiB0LmtpbmQsIGVuYWJsZWQ6IHQuZW5hYmxlZCwgaWQ6IHQuaWQgfSkpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY29uc29sZS53YXJuKCfimqDvuI8gUmVtb3RlIHZpZGVvIGVsZW1lbnQgbm90IGF2YWlsYWJsZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuXHJcbiAgICAgIHRoaXMucGMub25jb25uZWN0aW9uc3RhdGVjaGFuZ2UgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ1BlZXIgY29ubmVjdGlvbiBzdGF0ZTonLCB0aGlzLnBjLmNvbm5lY3Rpb25TdGF0ZSk7XHJcbiAgICAgICAgaWYgKHRoaXMucGMuY29ubmVjdGlvblN0YXRlID09PSAnZmFpbGVkJykge1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcignUGVlciBjb25uZWN0aW9uIGZhaWxlZCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5wYy5jb25uZWN0aW9uU3RhdGUgPT09ICdjb25uZWN0ZWQnKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnUGVlciBjb25uZWN0aW9uIGVzdGFibGlzaGVkJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG5cclxuICAgICAgdGhpcy5wYy5vbmljZWNvbm5lY3Rpb25zdGF0ZWNoYW5nZSA9ICgpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZygnSUNFIGNvbm5lY3Rpb24gc3RhdGU6JywgdGhpcy5wYy5pY2VDb25uZWN0aW9uU3RhdGUpO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgdGhpcy5wYy5vbmljZWdhdGhlcmluZ3N0YXRlY2hhbmdlID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdJQ0UgZ2F0aGVyaW5nIHN0YXRlOicsIHRoaXMucGMuaWNlR2F0aGVyaW5nU3RhdGUpO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgdGhpcy5wYy5vbmljZWNhbmRpZGF0ZSA9IGUgPT4ge1xyXG4gICAgICAgIGlmIChlLmNhbmRpZGF0ZSkge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ1NlbmRpbmcgSUNFIGNhbmRpZGF0ZScpO1xyXG4gICAgICAgICAgc29ja2V0LmVtaXQoJ2ljZScsIHsgcm9vbSwgY2FuZGlkYXRlOiBlLmNhbmRpZGF0ZSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyBSZWdpc3RlciBzb2NrZXQgbGlzdGVuZXJzIG9ubHkgb25jZVxyXG4gICAgICB0aGlzLnNldHVwU29ja2V0TGlzdGVuZXJzKHJvb20pO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coJ0pvaW5pbmcgcm9vbTonLCByb29tKTtcclxuICAgICAgY29uc29sZS5sb2coJ/Cfk40gTWFrZSBzdXJlIHlvdSBoYXZlIDIgcGVlcnMgaW4gdGhlIHNhbWUgcm9vbSBmb3IgdmlkZW8gdG8gd29yayEnKTtcclxuICAgICAgc29ja2V0LmVtaXQoJ2pvaW4nLCB7IHJvb20gfSk7XHJcbiAgICAgIFxyXG4gICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluaXRpYWxpemluZyBXZWJSVEM6JywgZXJyKTtcclxuICAgICAgdGhyb3cgZXJyO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXR1cFNvY2tldExpc3RlbmVycyhyb29tOiBzdHJpbmcpIHtcclxuICAgIC8vIFJlbW92ZSBvbGQgbGlzdGVuZXJzIGZpcnN0XHJcbiAgICBzb2NrZXQub2ZmKCdwZWVyLWpvaW5lZCcpO1xyXG4gICAgc29ja2V0Lm9mZignb2ZmZXInKTtcclxuICAgIHNvY2tldC5vZmYoJ2Fuc3dlcicpO1xyXG4gICAgc29ja2V0Lm9mZignaWNlJyk7XHJcblxyXG4gICAgc29ja2V0Lm9uKCdwZWVyLWpvaW5lZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc29sZS5sb2coJ/CflJQgW1NJR05BTElOR10gUGVlciBqb2luZWQgdGhlIHJvb20sIGNyZWF0aW5nIG9mZmVyLi4uJyk7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3Qgb2ZmZXIgPSBhd2FpdCB0aGlzLnBjLmNyZWF0ZU9mZmVyKCk7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ/Cfk6QgW1NJR05BTElOR10gT2ZmZXIgY3JlYXRlZDonLCBvZmZlci50eXBlKTtcclxuICAgICAgICBhd2FpdCB0aGlzLnBjLnNldExvY2FsRGVzY3JpcHRpb24ob2ZmZXIpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCfinJMgW1NJR05BTElOR10gTG9jYWwgZGVzY3JpcHRpb24gc2V0LCBzZW5kaW5nIG9mZmVyJyk7XHJcbiAgICAgICAgc29ja2V0LmVtaXQoJ29mZmVyJywgeyByb29tLCBvZmZlciB9KTtcclxuICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFtTSUdOQUxJTkddIEVycm9yIGNyZWF0aW5nIG9mZmVyOicsIGVycik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHNvY2tldC5vbignb2ZmZXInLCBhc3luYyAoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCfwn5OlIFtTSUdOQUxJTkddIFJlY2VpdmVkIG9mZmVyIGZyb20gcmVtb3RlIHBlZXInKTtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBvZmZlciA9IGRhdGEub2ZmZXIgfHwgZGF0YTtcclxuICAgICAgICBjb25zb2xlLmxvZygn8J+TpSBbU0lHTkFMSU5HXSBTZXR0aW5nIHJlbW90ZSBkZXNjcmlwdGlvbiBmb3Igb2ZmZXInKTtcclxuICAgICAgICBhd2FpdCB0aGlzLnBjLnNldFJlbW90ZURlc2NyaXB0aW9uKG5ldyBSVENTZXNzaW9uRGVzY3JpcHRpb24ob2ZmZXIpKTtcclxuICAgICAgICBjb25zb2xlLmxvZygn4pyTIFtTSUdOQUxJTkddIFJlbW90ZSBkZXNjcmlwdGlvbiBzZXQsIGNyZWF0aW5nIGFuc3dlci4uLicpO1xyXG4gICAgICAgIGNvbnN0IGFuc3dlciA9IGF3YWl0IHRoaXMucGMuY3JlYXRlQW5zd2VyKCk7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ/Cfk6QgW1NJR05BTElOR10gQW5zd2VyIGNyZWF0ZWQ6JywgYW5zd2VyLnR5cGUpO1xyXG4gICAgICAgIGF3YWl0IHRoaXMucGMuc2V0TG9jYWxEZXNjcmlwdGlvbihhbnN3ZXIpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCfinJMgW1NJR05BTElOR10gTG9jYWwgZGVzY3JpcHRpb24gc2V0LCBzZW5kaW5nIGFuc3dlcicpO1xyXG4gICAgICAgIHNvY2tldC5lbWl0KCdhbnN3ZXInLCB7IHJvb20sIGFuc3dlciB9KTtcclxuICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFtTSUdOQUxJTkddIEVycm9yIGhhbmRsaW5nIG9mZmVyOicsIGVycik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHNvY2tldC5vbignYW5zd2VyJywgYXN5bmMgKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICBjb25zb2xlLmxvZygn8J+TpSBbU0lHTkFMSU5HXSBSZWNlaXZlZCBhbnN3ZXIgZnJvbSByZW1vdGUgcGVlcicpO1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGFuc3dlciA9IGRhdGEuYW5zd2VyIHx8IGRhdGE7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ/Cfk6UgW1NJR05BTElOR10gU2V0dGluZyByZW1vdGUgZGVzY3JpcHRpb24gZnJvbSBhbnN3ZXI6JywgYW5zd2VyLnR5cGUpO1xyXG4gICAgICAgIGF3YWl0IHRoaXMucGMuc2V0UmVtb3RlRGVzY3JpcHRpb24obmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbihhbnN3ZXIpKTtcclxuICAgICAgICBjb25zb2xlLmxvZygn4pyTIFtTSUdOQUxJTkddIFJlbW90ZSBkZXNjcmlwdGlvbiBzZXQgLSBDb25uZWN0aW9uIHNob3VsZCBiZSBlc3RhYmxpc2hlZCcpO1xyXG4gICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgW1NJR05BTElOR10gRXJyb3IgaGFuZGxpbmcgYW5zd2VyOicsIGVycik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHNvY2tldC5vbignaWNlJywgYXN5bmMgKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGNhbmRpZGF0ZSA9IGRhdGEuY2FuZGlkYXRlIHx8IGRhdGE7XHJcbiAgICAgICAgaWYgKGNhbmRpZGF0ZSkge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ/Cfp4ogW0lDRV0gQWRkaW5nIElDRSBjYW5kaWRhdGUnKTtcclxuICAgICAgICAgIGF3YWl0IHRoaXMucGMuYWRkSWNlQ2FuZGlkYXRlKG5ldyBSVENJY2VDYW5kaWRhdGUoY2FuZGlkYXRlKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgW0lDRV0gRXJyb3IgYWRkaW5nIGljZSBjYW5kaWRhdGU6JywgZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNsZWFudXAoKSB7XHJcbiAgICBzb2NrZXQub2ZmKCdwZWVyLWpvaW5lZCcpO1xyXG4gICAgc29ja2V0Lm9mZignb2ZmZXInKTtcclxuICAgIHNvY2tldC5vZmYoJ2Fuc3dlcicpO1xyXG4gICAgc29ja2V0Lm9mZignaWNlJyk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzd2l0Y2hDYW1lcmEoKSB7XHJcbiAgICBpZiAoIXRoaXMubG9jYWxTdHJlYW0pIHtcclxuICAgICAgY29uc29sZS53YXJuKCdMb2NhbCBzdHJlYW0gbm90IGF2YWlsYWJsZScpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdmlkZW9UcmFja3MgPSB0aGlzLmxvY2FsU3RyZWFtLmdldFZpZGVvVHJhY2tzKCk7XHJcbiAgICAgIGlmICh2aWRlb1RyYWNrcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oJ05vIHZpZGVvIHRyYWNrcyBhdmFpbGFibGUnKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHZpZGVvVHJhY2sgPSB2aWRlb1RyYWNrc1swXTtcclxuICAgICAgY29uc3Qgc2V0dGluZ3MgPSB2aWRlb1RyYWNrLmdldFNldHRpbmdzKCk7XHJcbiAgICAgIGNvbnN0IG5ld0ZhY2luZyA9IHNldHRpbmdzLmZhY2luZ01vZGUgPT09ICd1c2VyJyA/ICdlbnZpcm9ubWVudCcgOiAndXNlcic7XHJcblxyXG4gICAgICBjb25zdCBzdHJlYW0gPSBhd2FpdCBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSh7XHJcbiAgICAgICAgdmlkZW86IHsgZmFjaW5nTW9kZTogbmV3RmFjaW5nIH0sXHJcbiAgICAgICAgYXVkaW86IHRydWVcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCBuZXdUcmFjayA9IHN0cmVhbS5nZXRWaWRlb1RyYWNrcygpWzBdO1xyXG4gICAgICBjb25zdCBzZW5kZXIgPSB0aGlzLnBjLmdldFNlbmRlcnMoKS5maW5kKHMgPT4gcy50cmFjaz8ua2luZCA9PT0gJ3ZpZGVvJyk7XHJcbiAgICAgIFxyXG4gICAgICBpZiAoc2VuZGVyKSB7XHJcbiAgICAgICAgYXdhaXQgc2VuZGVyLnJlcGxhY2VUcmFjayhuZXdUcmFjayk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHZpZGVvVHJhY2suc3RvcCgpO1xyXG4gICAgICB0aGlzLmxvY2FsU3RyZWFtLnJlbW92ZVRyYWNrKHZpZGVvVHJhY2spO1xyXG4gICAgICB0aGlzLmxvY2FsU3RyZWFtLmFkZFRyYWNrKG5ld1RyYWNrKTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBzd2l0Y2hpbmcgY2FtZXJhOicsIGVycik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBsZWF2ZSgpIHtcclxuICAgIGNvbnNvbGUubG9nKCdMZWF2aW5nIGNhbGwuLi4nKTtcclxuICAgIHRoaXMuY2xlYW51cCgpO1xyXG4gICAgdGhpcy5pc0luaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICB0aGlzLmxvY2FsU3RyZWFtPy5nZXRUcmFja3MoKS5mb3JFYWNoKHQgPT4gdC5zdG9wKCkpO1xyXG4gICAgdGhpcy5wYz8uY2xvc2UoKTtcclxuICAgIHNvY2tldC5lbWl0KCdsZWF2ZScsIHsgcm9vbTogdGhpcy5jdXJyZW50Um9vbSB9KTtcclxuICB9XHJcblxyXG4gIHBhdXNlKCkge1xyXG4gICAgdGhpcy5sb2NhbFN0cmVhbT8uZ2V0VHJhY2tzKCkuZm9yRWFjaCh0ID0+IHQuZW5hYmxlZCA9IGZhbHNlKTtcclxuICB9XHJcblxyXG4gIHJlc3VtZSgpIHtcclxuICAgIHRoaXMubG9jYWxTdHJlYW0/LmdldFRyYWNrcygpLmZvckVhY2godCA9PiB0LmVuYWJsZWQgPSB0cnVlKTtcclxuICB9XHJcblxyXG4gIHRvZ2dsZUF1ZGlvKGVuYWJsZWQ6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMubG9jYWxTdHJlYW0/LmdldEF1ZGlvVHJhY2tzKCkuZm9yRWFjaCh0ID0+IHQuZW5hYmxlZCA9IGVuYWJsZWQpO1xyXG4gIH1cclxuXHJcbiAgdG9nZ2xlVmlkZW8oZW5hYmxlZDogYm9vbGVhbikge1xyXG4gICAgdGhpcy5sb2NhbFN0cmVhbT8uZ2V0VmlkZW9UcmFja3MoKS5mb3JFYWNoKHQgPT4gdC5lbmFibGVkID0gZW5hYmxlZCk7XHJcbiAgfVxyXG59XHJcbiJdfQ==